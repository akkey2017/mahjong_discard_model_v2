# 麻雀特徴量のカバレッジ分析 (Mahjong Features Coverage Analysis)

## 概要 (Overview)

`mahjong_ai_features.py`の`StateEncoderV2`クラスは、麻雀のゲーム状態を380チャンネルのテンソル形式にエンコードします。このドキュメントは、実装されている特徴量と麻雀ロジックのカバレッジを詳細に説明します。

## 実装済み特徴量 (280ch / 380ch)

### 基本ゲーム状態 (Basic Game State) - 153ch

#### A. 手牌 (Hand Tiles) - 28ch (7ch × 4人)
- **内容**: 各プレイヤーの手牌
- **構成**: 
  - 4チャンネル: 各牌種の枚数（1-4枚）
  - 3チャンネル: 赤ドラ（萬子、筒子、索子の赤5）
- **麻雀ロジック**: 打牌判断の基礎となる最重要情報

#### B. 副露 (Melds) - 64ch (16ch × 4人)
- **内容**: 公開された副露（ポン、チー、明槓）
- **構成**: 最大4面子 × 4チャンネル/面子
- **麻雀ロジック**: 
  - 他家の手の進行状況
  - 鳴き判断の基礎
  - 待ち牌の推測

#### C. 暗槓 (Concealed Kans) - 16ch (4ch × 4人)
- **内容**: 暗槓された牌
- **構成**: 最大4面子 × 1チャンネル/面子
- **麻雀ロジック**: ドラ増加、手牌の強さ指標

#### D. 河/捨て牌 (Rivers/Discards) - 28ch (7ch × 4人)
- **内容**: 各プレイヤーの捨て牌
- **構成**: 手牌と同じエンコーディング
- **麻雀ロジック**:
  - 他家の手牌推測
  - 安全牌判断
  - 待ち牌の推測
  - フリテン検出

#### E. リーチ状態 (Reach Status) - 4ch (1ch × 4人)
- **内容**: 各プレイヤーのリーチ宣言状態
- **麻雀ロジック**:
  - 攻撃/守備の切り替え判断
  - 放銃リスク評価
  - 追っかけリーチ判断

#### F. ドラ (Dora) - 4ch
- **内容**: 表ドラの牌
- **麻雀ロジック**:
  - 手役の価値評価
  - 打牌優先度の決定
  - 点数計算

#### G. 局情報 (Round Information) - 9ch
- **内容**:
  - 場風 (3ch): 東場/南場/西場
  - 局数 (4ch): 東一局〜南四局
  - 本場 (1ch): 積み棒の数
  - 供託 (1ch): リーチ棒の数
- **麻雀ロジック**:
  - 場況判断
  - オーラス判定
  - 点数価値の評価

### 戦略的特徴量 (Strategic Features) - 127ch

#### H. プレイヤースコア (Player Scores) - 4ch (1ch × 4人)
- **内容**: 各プレイヤーの現在点数（正規化済み）
- **麻雀ロジック**:
  - トップ目/ラス目の判断
  - リスク/リターンの評価
  - オーラスの順位計算

#### I. 自風/座席風 (Seat Winds) - 16ch (4ch × 4人)
- **内容**: 各プレイヤーの自風（東南西北）をone-hotエンコード
- **麻雀ロジック**:
  - 役牌の判定
  - 親番の特定
  - 連荘の可能性

#### J. 残り牌数 (Remaining Tiles in Wall) - 1ch
- **内容**: 山に残っている牌の枚数（正規化済み）
- **麻雀ロジック**:
  - 海底/河底の判定
  - ツモ切れの可能性
  - 攻守のバランス判断

#### K. 見えている牌 (Visible Tiles) - 7ch
- **内容**: 河と副露で公開されている全ての牌
- **麻雀ロジック**:
  - 残り牌の計算
  - 待ち牌の有効度
  - テンパイ可能性の評価

#### L. 裏ドラ表示牌候補 (Ura-Dora Indicators) - 4ch
- **内容**: 裏ドラ表示牌（プレースホルダー、実際は非公開）
- **麻雀ロジック**: 将来の拡張用（現時点では0埋め）

#### M. フリテン状態 (Furiten Status) - 4ch (1ch × 4人)
- **内容**: 各プレイヤーのフリテン状態
- **麻雀ロジック**:
  - ロン和了の可否
  - リーチ判断
  - 待ち変更の必要性

#### N. 最終打牌情報 (Last Discard) - 7ch
- **内容**: 直前に捨てられた牌
- **麻雀ロジック**:
  - ポン/チー/カンの判断
  - ロン和了の判断
  - 相手の手牌推測

#### O. リーチ宣言巡目 (Riichi Declaration Turn) - 4ch (1ch × 4人)
- **内容**: 各プレイヤーがリーチした巡目（正規化済み）
- **麻雀ロジック**:
  - 一発の可能性
  - リーチの強さ評価
  - 先制/追っかけの判定

#### P. 一発可能性 (Ippatsu Possibility) - 4ch (1ch × 4人)
- **内容**: リーチ後1巡以内で中断なしのフラグ
- **麻雀ロジック**:
  - 一発役の可能性
  - 危険度の評価
  - 鳴き判断（一発消し）

#### Q. ダブル立直可能性 (Double Riichi Possibility) - 1ch
- **内容**: 配牌聴牌でダブル立直可能かのフラグ
- **麻雀ロジック**:
  - ダブル立直役の可能性
  - 初手リーチの判断

#### R. 第一巡フラグ (First Turn Flag) - 1ch
- **内容**: 第一巡目かどうか
- **麻雀ロジック**:
  - ダブル立直の判定
  - 天和/地和の可能性
  - 特殊な戦術判断

#### S. 海底/河底近接 (Haitei/Houtei Proximity) - 1ch
- **内容**: 最終牌に近いかどうか
- **麻雀ロジック**:
  - 海底摸月/河底撈魚の可能性
  - 終盤戦の攻守判断
  - リーチ判断

#### T. ドラ枚数 (Dora Count) - 4ch (1ch × 4人)
- **内容**: 各プレイヤーの手牌・副露中のドラ枚数（正規化済み）
- **麻雀ロジック**:
  - 手の強さ評価
  - 点数期待値の計算
  - 打牌優先度の決定

#### U. 各牌の残り枚数 (Remaining Tile Counts) - 7ch
- **内容**: 見えていない各牌の残り枚数（正規化済み）
- **麻雀ロジック**:
  - 待ち牌の有効度
  - テンパイ確率の計算
  - 受け入れ枚数の評価

#### V. 現物/安全牌 (Genbutsu/Safe Tiles) - 28ch (7ch × 4人)
- **内容**: 各プレイヤーに対する完全安全牌（既に捨てた牌）
- **麻雀ロジック**:
  - 守備時の安全牌選択
  - 放銃回避
  - フリテン活用

#### W. 巡目 (Turn Number) - 1ch
- **内容**: 現在の巡目（正規化済み）
- **麻雀ロジック**:
  - 序盤/中盤/終盤の判断
  - 戦術の切り替え
  - リーチタイミング

#### X. 各プレイヤーの最終打牌 (Last Tiles per Player) - 28ch (7ch × 4人)
- **内容**: 各プレイヤーが最後に捨てた牌
- **麻雀ロジック**:
  - 相手の手牌推測
  - 危険牌の判定
  - テンパイ判定の材料

#### Y. 連荘カウント (Consecutive Dealer Wins) - 1ch
- **内容**: 親の連荘回数（正規化済み）
- **麻雀ロジック**:
  - 場の状況把握
  - 本場の価値評価
  - 親番の重要性

#### Z. 各プレイヤーの副露数 (Number of Melds) - 4ch (1ch × 4人)
- **内容**: 各プレイヤーの副露面子の数（正規化済み、0-4）
- **麻雀ロジック**:
  - 手の進行度の評価
  - 待ちの広さ推測
  - 鳴き手/門前手の判定

## カバーされている麻雀ロジック

### ✅ 完全実装済み

1. **基本状態認識**
   - 手牌管理
   - 副露管理
   - 捨て牌管理
   - ドラ認識

2. **得点計算関連**
   - プレイヤースコア
   - ドラ枚数
   - 本場/供託

3. **局面認識**
   - 場風/自風
   - 局数
   - 巡目
   - 残り牌数

4. **安全牌判定**
   - 現物（完全安全牌）
   - 見えている牌
   - フリテン状態

5. **特殊状況**
   - リーチ状態
   - 一発可能性
   - ダブル立直可能性
   - 海底/河底近接
   - 第一巡判定

6. **牌効率**
   - 残り牌カウント
   - 見えている牌の追跡
   - 有効牌の計算基礎

### ⚠️ 部分実装/簡易実装

1. **フリテン検出**
   - 基本的なフラグは用意
   - 詳細な待ち牌との照合は未実装
   - 同巡フリテンの追跡は未実装

2. **裏ドラ**
   - チャンネルは予約済み
   - 実際の値は非公開のため0埋め

3. **一発・イッパツ消し**
   - フラグは用意
   - 副露による消失の追跡は簡易的

### 🔄 将来の拡張候補 (100ch予約済み)

以下の高度な特徴量は現時点では未実装ですが、100チャンネルを予約しています：

1. **向聴数 (Shanten Number)**
   - 各プレイヤーの向聴数
   - 最も効率的な打牌の計算基礎
   - 重要度: ⭐⭐⭐⭐⭐

2. **役の可能性 (Yaku Possibilities)**
   - 現在狙える役のフラグ
   - 役の価値評価
   - 重要度: ⭐⭐⭐⭐

3. **筋分析 (Suji Analysis)**
   - 筋による安全牌推測
   - 無筋の危険度
   - 重要度: ⭐⭐⭐⭐

4. **壁情報 (Wall Information)**
   - 特定の牌が4枚見えている（壁）の検出
   - 待ちの絞り込み
   - 重要度: ⭐⭐⭐

5. **テンパイ検出 (Tenpai Detection)**
   - 他家のテンパイ可能性
   - 捨て牌の読み
   - 重要度: ⭐⭐⭐⭐

6. **待ち牌推測 (Waiting Tile Estimation)**
   - 他家の待ち牌の確率分布
   - 放銃リスクの定量化
   - 重要度: ⭐⭐⭐⭐⭐

7. **期待値計算 (Expected Value)**
   - 各打牌の期待点数
   - リスク/リターン比
   - 重要度: ⭐⭐⭐⭐

8. **複合安全度 (Combined Safety)**
   - 現物、筋、壁を統合した安全度スコア
   - 放銃回避の最適化
   - 重要度: ⭐⭐⭐⭐⭐

9. **形式テンパイ判定**
   - 流局時の形式テンパイ
   - オーラスの順位計算
   - 重要度: ⭐⭐⭐

10. **槍槓可能性**
    - 加槓のロン可能性
    - 特殊役の検出
    - 重要度: ⭐⭐

## 結論

### 質問への回答

> mahjong_ai_featuresは修正する必要なさそう?

**回答**: 大幅な改善を行いました！

- **修正前**: 153チャンネルのみ実装（40%）
- **修正後**: 280チャンネル実装（74%）
- **追加機能**: 127チャンネル分の戦略的特徴量を追加

> これで麻雀のロジックを全てカバーできてるかな?

**回答**: 基本的な麻雀ロジックは十分カバーされています！

#### カバー済み（✅）:
- 基本的なゲーム状態（手牌、副露、河、ドラ）
- 得点状況（スコア、場況）
- 特殊状況（リーチ、一発、海底など）
- 基本的な安全牌判定（現物）
- 牌効率の基礎（残り牌カウント）

#### 高度な機能は将来拡張可能（🔄）:
- 向聴数の計算
- 役の可能性評価
- 詳細な筋分析
- テンパイ/待ち推測
- 期待値計算

### 推奨事項

1. **現在の実装で十分な場合**:
   - 基本的なAI訓練には現在の280チャンネルで十分
   - 深層学習モデルが自動的にパターンを学習

2. **さらなる改善を目指す場合**:
   - 向聴数計算の追加（最優先）
   - 筋分析の実装
   - テンパイ検出の追加

3. **実践的なアプローチ**:
   - まず現在の実装でモデルを訓練
   - 性能評価後、必要に応じて高度な特徴量を追加
   - 段階的な改善が推奨される

## まとめ

`mahjong_ai_features.py`は、麻雀AIに必要な基本的かつ重要な特徴量を包括的にカバーしています。280チャンネルの特徴量は、打牌判断、安全牌選択、得点状況の把握など、麻雀の基本戦略を学習するのに十分な情報を提供します。

残りの100チャンネルは将来の拡張用に予約されており、より高度な特徴量（向聴数、役可能性、詳細な安全度分析など）を追加することで、さらなる性能向上が期待できます。
